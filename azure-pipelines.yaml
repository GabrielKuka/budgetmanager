trigger:
  - master

pool:
  name: server1_pool

variables:
  dockerComposeFile: "docker-compose.yml"

stages:
  - stage: BuildAndDeploy
    displayName: "Build and Deploy BudgetManager"
    jobs:
      - job: StopContainers
        displayName: "Stop Existing Containers (frontend & backend)"
        steps:
          - script: |
              echo "Stopping existing containers..."
              docker-compose -f $(dockerComposeFile) -p budget_manager down --remove-orphans
            displayName: "Run docker-compose down"
            continueOnError: false
          - script: |
              echo "Listing all containers after stopping..."
              docker ps
            displayName: "List containers (after)"

      - job: StartContainers
        displayName: "Start New Containers (frontend & backend)"
        dependsOn: StopContainers
        condition: succeeded('StopContainers')
        steps:
          - script: |
              echo "Building and starting new containers..."
              docker-compose -f $(dockerComposeFile) -p budget_manager up -d --build
            displayName: "Run docker-compose up"
